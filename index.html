<html>
 <head>
  <link href="https://fonts.googleapis.com/css2?family=Coda&display=swap" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
  <style>
   table {
    font-family: arial, sans-serif;
    border-collapse: collapse;
    width: 100%;
   }

   td, th {
    border: 1px solid #dddddd;
    text-align: left;
    padding: 8px;
   }

   tr:nth-child(even) {
    background-color: #dddddd;
   }

   body,table {
    font-family: 'Coda',cursive;
   }

  </style>
 </head>
 <body>
  <div id="toolBar" style="width:100%; margin-top: 16px;margin-left:16px;margin-right: 16px;">
   <button id="btnAbout" onclick="showAbout()">About</button>
  </div>
  <div id="content" style="width:100%; height:auto; margin-left: 16px;margin-right: 16px;margin-bottom: 16px;" onclick="changePageState(0);">
   <div id="infoDivContainer" style="position:fixed; width:100%; height:100%; z-index:1; background-color: rgba(0,0,0,0.5)">
    <div id="infoDiv" style="position:fixed; border-style:solid; width:50%; left:50%; transform:translate(-50%,0); background: #fff;opacity: 1;padding-left: 5%;padding-bottom: 5%;padding-right: 5%;padding-top: 2%;" onclick="event.stopPropagation();">
     <h1>Project</h1>
     <div id="infoID">ID: none</div><br>
     <div id="infoType">Type: none</div><br>
     <div id="infoName">Name: none</div><br>
     <div id="infoStatus">Status: none</div><br>
     <div id="infoTimeline">Timeline: </div>

     <div id="infoTableDiv">
      <table id="infoTable">
       <tr>
        <th>Date</th>
        <th>Status</th>
       </tr>
      </table>
     </div>
    </div>
   </div>


   <div id="tablesDiv" style="z-index: 0" onclick="event.stopPropagation();">
    <div id="nextAr" style="margin-top: 8px;margin-left: 8px;margin-right: 8px;margin-bottom: 8px;">
     <table id="projNextArTable">
      <tr>
       <th colspan="6">Next Arrival:</th>
      </tr>
      <tr>
       <th style="width: 10%;">ID</th>
       <th style="width: 10%;">Type</th>
       <th style="width: 30%;">Name</th>
       <th style="width: 10%;">Status</th>
       <th style="width: 10%;">Appear date</th>
       <th style="width: 10%;">Last update</th>
      </tr>
     </table>
    </div>

    <div id="upcoming" style="margin-top: 8px;margin-left: 8px;margin-right: 8px;margin-bottom: 8px;">
     <table id="projUpcomingTable">
      <tr>
       <th colspan="6">Upcoming:</th>
      </tr>
      <tr>
       <th style="width: 10%;">ID</th>
       <th style="width: 10%;">Type</th>
       <th style="width: 30%;">Name</th>
       <th style="width: 10%;">Status</th>
       <th style="width: 10%;">Appear date</th>
       <th style="width: 10%;">Last update</th>
      </tr>
     </table>
    </div>

    <div id="inProd" style="margin-top: 8px;margin-left: 8px;margin-right: 8px;margin-bottom: 8px;">
     <table id="projInProdTable">
      <tr>
       <th colspan="6">In Production:</th>
      </tr>
      <tr>
       <th style="width: 10%;">ID</th>
       <th style="width: 10%;">Type</th>
       <th style="width: 30%;">Name</th>
       <th style="width: 10%;">Status</th>
       <th style="width: 10%;">Appear date</th>
       <th style="width: 10%;">Last update</th>
      </tr>
     </table>
    </div>

    <div id="inPlan" style="margin-top: 8px;margin-left: 8px;margin-right: 8px;margin-bottom: 8px;">
     <table id="projInPlanTable">
      <tr>
       <th colspan="6">In Planning:</th>
      </tr>
      <tr>
       <th style="width: 10%;">ID</th>
       <th style="width: 10%;">Type</th>
       <th style="width: 30%;">Name</th>
       <th style="width: 10%;">Status</th>
       <th style="width: 10%;">Appear date</th>
       <th style="width: 10%;">Last update</th>
      </tr>
     </table>
    </div>

    <div id="rel" style="margin-top: 8px;margin-left: 8px;margin-right: 8px;margin-bottom: 8px;">
     <table id="projRelTable">
      <tr>
       <th colspan="6">Released:</th>
      </tr>
      <tr>
       <th style="width: 10%;">ID</th>
       <th style="width: 10%;">Type</th>
       <th style="width: 30%;">Name</th>
       <th style="width: 10%;">Status</th>
       <th style="width: 10%;">Appear date</th>
       <th style="width: 10%;">Last update</th>
      </tr>
     </table>
    </div>

    <div id="can" style="margin-top: 8px;margin-left: 8px;margin-right: 8px;margin-bottom: 8px;">
     <table id="projCanTable">
      <tr>
       <th colspan="6">Canceled:</th>
      </tr>
      <tr>
       <th style="width: 10%;">ID</th>
       <th style="width: 10%;">Type</th>
       <th style="width: 30%;">Name</th>
       <th style="width: 10%;">Status</th>
       <th style="width: 10%;">Appear date</th>
       <th style="width: 10%;">Last update</th>
      </tr>
     </table>
    </div>
   </div>
  </div>


  <script>
   var projectsJSON = "";
   var state = 0; //ProjectTable = 0, ProjectInfo = 1
   var projectTableDict = {
    "Next Arrival": "projNextArTable",
    "Upcoming": "projUpcomingTable",
    "In Production": "projInProdTable",
    "In Planning": "projInPlanTable",
    "Released": "projRelTable",
    "Canceled": "projCanTable"
   }
   
   projectsJSON = $.getJSON("data.json",createWebPage());
   
   function createWebPage(){
    createProjectTable();
   }
   
   function createProjectTable() {  
    //let data = await fetch("https://raw.githubusercontent.com/MrAsieru/TSWRoadmapTracker/master/data.json").then((response) => {return response.json()});
    //projectsJSON = data.Projects;
    document.getElementById("projNextArTable").style.wordWrap = "break-word";
    document.getElementById("projUpcomingTable").style.wordWrap = "break-word";
    document.getElementById("projInProdTable").style.wordWrap = "break-word";
    document.getElementById("projInPlanTable").style.wordWrap = "break-word";
    document.getElementById("projRelTable").style.wordWrap = "break-word";
    document.getElementById("projCanTable").style.wordWrap = "break-word";

    var rowClickHandler = function(row) {
     return function() {
      projectSelected(row.getElementsByTagName("td")[0].innerHTML);
     };
    };

    for (var i in projectsJSON){
     let table = document.getElementById(projectTableDict[projectsJSON[i].timeline.status[projectsJSON[i].timeline.status.length - 1]]);
     let row = table.insertRow();
     let id = row.insertCell();
     id.innerHTML = projectsJSON[i].id;
     let type = row.insertCell();
     type.innerHTML = setProjectTypeColor(projectsJSON[i].type);
     let name = row.insertCell();
     name.innerHTML = projectsJSON[i].name;
     let status = row.insertCell();
     status.innerHTML = projectsJSON[i].timeline.status[projectsJSON[i].timeline.status.length - 1]
     let appDate = row.insertCell();
     appDate.innerHTML = projectsJSON[i].timeline.dates[0];
     let lastUpd = row.insertCell();
     lastUpd.innerHTML = projectsJSON[i].timeline.dates[findLastStatusChange(projectsJSON[i].timeline)];
     row.onclick = rowClickHandler(row);
    }
   }

   function setProjectTypeColor(type){
    let result,start = "";
    switch(type) {
     case "Preserved Collection":
     start = '<p style="background-color:LimeGreen;">';
     break;
     case "Route Add-On":
     start = '<p style="background-color:Orange;">';
     break;
     case "Loco Add-On":
     start = '<p style="background-color:LightBlue;">';
     break;
     case "Upgrade":
     start = '<p style="background-color:Tomato;">';
     break;
     case "Feature":
     start = '<p style="background-color:Blue;">';
     break;
     case "Fix":
     start = '<p style="background-color:Purple;">';
     break;
     case "Route Upgrade":
     start = '<p style="background-color:Olive;">';
     break;
     case "Released":
     start = '<p style="background-color:Magenta;">';
     break;
    }
    return (start+type+"</p>")
   }

   function arrayFind(data,val){
    var i = 0;
    var finished = false;
    while(i < data.length && !finished) {
     if (data[i].id == val) {
      finished = true;
     } else {
      i++;
     }
    }
    if (finished) {
     return i;
    } else {
     return null;
    }
   }

   function changePageState(newState){
    switch(newState){
     case 0:<!-- Show table -->
      document.getElementById("infoDivContainer").style.display = "none";
      state = 0;
      break;
     case 1:<!-- Show info -->
      document.getElementById("infoDivContainer").style.display = "";
      state = 1;
      break;
    }
   }

   function printProjectInfo(id){
    console.log(state+" "+id);
    let index = arrayFind(projectsJSON,id);
    //Print info
    document.getElementById('infoID').innerHTML = "ID: "+id;
    document.getElementById('infoType').innerHTML = "Type: "+projectsJSON[index].type;
    document.getElementById('infoName').innerHTML = "Name: "+projectsJSON[index].name;
    document.getElementById('infoStatus').innerHTML = "Status: "+projectsJSON[index].timeline.status[projectsJSON[index].timeline.status.length - 1];

    //Add rows
    let table = document.getElementById("infoTable");
    for (var i in projectsJSON[index].timeline.dates) {
     let row = table.insertRow();
     let date = row.insertCell();
     date.innerHTML = projectsJSON[index].timeline.dates[i];
     let status = row.insertCell();
     status.innerHTML = projectsJSON[index].timeline.status[i];
    }  
   }

   function clearProjectInfo() {
    document.getElementById('infoID').innerHTML = "ID: none";
    document.getElementById('infoType').innerHTML = "Type: none";
    document.getElementById('infoName').innerHTML = "Name: none";
    document.getElementById('infoStatus').innerHTML = "Status: none";
    let table = document.getElementById("infoTable");
    let rowL = table.rows.length;
    for (i = 1; i < rowL; i++){
     table.deleteRow(-1);
    } 
   }

   function  findLastStatusChange(timeline){
    let i = timeline.dates.length - 1;
    let found = false;
    let lastStatus = timeline.status[i];
    while(i >= 0 && !found){
     if (timeline.status[i] != lastStatus){
      found = true;
     } else {
      i--;
     }
    }
    return ++i;
   }

   function projectSelected(id){
    if (state == 0){
     clearProjectInfo();
     printProjectInfo(id);
    }

    changePageState(1);
   }

   changePageState(0); //Hide infoDivContainer
  </script>
 </body>
</html>